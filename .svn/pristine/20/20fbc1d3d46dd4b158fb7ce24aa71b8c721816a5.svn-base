package services;

import java.util.Collection;

import javax.transaction.Transactional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.Assert;

import repositories.RequestRepository;
import security.Authority;
import security.LoginService;
import security.UserAccount;
import domain.Customer;
import domain.Request;

@Service
@Transactional
public class RequestService {

	// Repositories
	//====================================================================

	@Autowired
	private RequestRepository	requestRepository;
	
	// Supporting services
	//====================================================================
	
	@Autowired
	private CustomerService customerService;
	
	// Simple CRUD methods
	//====================================================================
	
	public Request findOne(int requestId){
		Assert.isTrue(requestId != 0);
		Request result;

		result = requestRepository.findOne(requestId);

		return result;
	}

	public Collection<Request> findAll() {
		Collection<Request> result;

		result = requestRepository.findAll();

		return result;
	}

	public Request create() {
		Request result;
		Customer customer;
		
		UserAccount userAccount = LoginService.getPrincipal();
		Authority i = new Authority();
		i.setAuthority("CUSTOMER");
		Assert.isTrue(userAccount.getAuthorities().contains(i));

		customer= customerService.findByPrincipal();
		
		result = new Request();
		result.setBan(false);
		result.setCustomer(customer);

		return result;
	}

	public Request save(Request request) {
		Assert.notNull(request);
		Request result;
		Customer customer;

		UserAccount userAccount = LoginService.getPrincipal();
		Authority i = new Authority();
		i.setAuthority("CUSTOMER");
		Assert.isTrue(userAccount.getAuthorities().contains(i));
		
		customer = customerService.findByPrincipal();
		Assert.isTrue(customer.equals(request.getCustomer()));

		result = requestRepository.save(request);

		return result;
	}

	public void delete(Request request) {
		Assert.notNull(request);
		Customer customer;

		UserAccount userAccount = LoginService.getPrincipal();
		Authority i = new Authority();
		i.setAuthority("CUSTOMER");
		Assert.isTrue(userAccount.getAuthorities().contains(i));
		
		customer = customerService.findByPrincipal();
		Assert.isTrue(customer.equals(request.getCustomer()));

		requestRepository.delete(request);
	}
	
	// Other business methods
	// ===================================================================
	
	public Collection<Request> getRequestByKeyWord(String keyWord){
		Assert.notNull(keyWord);
		Collection<Request> result;
		
		result = requestRepository.searchRequestByWords(keyWord);
		
		return result;
	}
	
	public Double ratioOfRequests(){
		Double result;
		
		result = requestRepository.ratioOfRequests();
		Assert.notNull(result);
		
		return result;
	}
}
